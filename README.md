<p align=right>
<a href=https://autorelease.bots.palantir.build/devx/choria-keycloak-oidc><img src=https://shields.palantir.build/badge/Perform%20an-Autorelease-brightgreen.svg alt=Autorelease></a>
</p>

choria-keycloak-oidc
==================
An SLS service written in Go.

## Getting Started

### Setup
* [Install Go](https://golang.org/doc/install) if it is not already present
* Clone this repo
* Run initial setup tasks in the local repository:

```bash
# install commit hook to verify ./godelw format passes before committing
./godelw git-hooks

# (optional) generate GoLand project files
./godelw goland
```

* In your code editor, search for `devx/choria-keycloak-oidc` and replace with
  `<actual Github organization where your repo lives>/choria-keycloak-oidc`
* To develop locally, use a self-signed certificate. Edit `cmd/server.go` and
  inside `serverCmd`, add `WithSelfSignedCertificate()` so the command reads:

```go
return server.New().
  WithSelfSignedCertificate().
  WithInstallConfigType(config.InstallConfig{}).
  ...
```

### Run the server
1. `./godelw run choria-keycloak-oidc server -- --install-config ./dist/var/conf/install.yml --runtime-config ./dist/var/conf/runtime.yml`
2. Navigate to `https://localhost:8080/choria-keycloak-oidc/echo/foo` to make a call to the API. You may need to accept your
   self-signed certificate.

### Gödel Tasks
Refer to the README and Wiki of the [gödel](https://github.com/palantir/godel) project for information on the tasks that
can be run.

## Understanding this App

### Folder Structure
The project contains the following main folders:

* Root directory
  * Contains `main.go`, which is the main package and contains the main function that acts as the entry point for
    the program.
* `cmd`
  * Contains the CLI commands for the program.
  * `cmd/server`
    * The application's server code. The server is a Go application. Tests are run using godel or go directly. The build
	  system uses [gödel](https://github.com/palantir/godel).
* `go.mod` and `go.sum`
  * These files are used to define the module for the project and define dependencies
  * `go.mod` defines the module and contains the dependencies (along with any replacement rules)
  * `go.sum` contains the module checksums -- it is generated by Go commands and should not be hand-edited
* `vendor`
  * Contains the code for the dependencies for the project
  * This directory is fully managed by Go module operations and should not be hand-edited

### Managing Dependencies
Dependencies are managed using go modules. This project uses the practice of using the vendor mode for modules, which
places all of the source code for the module dependencies in the "vendor" directory. For further information on
dependency management, refer to the [documentation](https://github.palantir.build/deployability/gommelier/blob/develop/dependencies.md).

## Ecosystem

### Build Tools
| Tool     | Links                                              |
| ---------| ---------------------------------------------------|
| Go       | https://golang.org/                                |
| gödel    | https://github.com/palantir/godel                  |

## Packaging
Packaging the distribution is handled by gödel's `dist` task. The following command creates an SLS distribution for each
of the `main` packages in the project in the `dist/` directory:

```bash
./godelw dist
```

Refer to the gödel documentation for details on customizing the `dist` task.

## CI & Publishing
This repository includes a fully functional `.circleci/config.yml`. Projects based on this repository can publish
artifacts to Artifactory using the following steps:

1. [Create a CircleCI project for the repository](https://circle.palantir.build/add-projects)
2. [Set up authentication with with Artifactory](https://rtfm.palantir.build/docs/devtools/master/building-projects/publishing.html)
  - Ensure that the PR specifies the CircleCI project created in step 1 and that it can write to the `group-id` in `godel/config/dist.yml`
  - Publishes will not succeed until the `artifactory-automation` PR has been merged

Once this configuration has been done, builds on CircleCI for the project on the `develop` branch and for any release
tags will publish its artifacts to Artifactory.
